---
title: Modelling the hydrolysis of wheat starch
subtitle: 
author:  Yuzi Wang
affiliation: CSIRO Agriculture & food
photo: resources/img/profile_photo.jpg

short_title: Optional short title

output: DSreport::project_summary
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  results = 'asis',
  echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.align = 'center'
)

#Load libraries
library(tidyverse)
library(gapminder)
library(kableExtra)
```


# Introduction

I'm a phD student in the cereal quality group of Ag & food. Without any programming experience before, the data school is sort of a whole new world for me, and it turned out to be very intereting and I'm keen to learn more.

# My Project

The project is about modelling the degradation of wheat starch, the end goal is to built a model that predict the degradability of wheat starch from some structural properties.   

## Preliminary results

The current dataset came from the hydrolysis of more than 200 wheat starch and also some other structural properties as well. 

**Tables**
```{r mytable, out.width='100%', echo = F}

mydata <- read_csv("data/tidydata/joined_6P.csv") %>% 
  select(Sample, ID, Time, Hydro_extent, Amylose_content, D1, D5, D9, mean_Peak, mean_Trough, mean_Final, mean_PastingTemp)

knitr::kable(head(mydata, n = 5), format = "html", caption = "Current dataset") %>% 
  kable_styling("striped")
```

<style> 
.column-left{float: left; width: 50%; text-align: left;}
.column-right{float: right;width: 50%;text-align: right}
</style>

<div class="column-left">

# My Digital Toolbox

* before : Excel, SPSS, Origin
* now : R 

# My time went ...

- tidying the data (the most time-consuming part)
- plotting
- curve fitting
- collecting all the estimated parameters from the model

# Next steps

Establishing a predictive model using the Partial least squares (PLS) regression.

</div>

<div class="column-right"> 

```{r heatmap-plot, out.width='100%', fig.align='center', fig.height= 4, fig.width=4, fig.dpi = 300, fig.cap="Heatmap"}


# import the dataset

data_6P <- read_csv("data/tidydata/data_6P_cal_3nd.csv")

# select the colmuns needed

data_selected <- data_6P %>% 
  filter(Sample != "C+" & Sample != "C-") %>%  # remove the control samples 
  select(Plate, Row, Col, Time, HE) %>% 
  rename(Column = Col) %>% 
  filter(Time == 0 | Time == 120 | Time == 240 | Time == 360 | Time == 1440 |Time == 1800) %>% 
  mutate_each(funs(replace(., .<0, 0))) # replace the negtive values by 0


# plot at time 1800min

### filter the time points

data_t0 <- data_selected %>% 
  filter(Time == 360) %>% 
  filter(!(Column == 7 & Row == "F" & Plate == 6)) %>% # remove an "outlier"
  filter(!(Column == 1 & Row == "F" & Plate == 1)) %>% # remove an "outlier"
  filter(!(Column == 9 & Row == "H" & Plate == 6)) # remove an "outlier"

### plotting

data_t0 %>% 
  ggplot(aes(x = Column, y = Row, fill = HE)) + 
  scale_fill_continuous(name = "Hydrolysis extent", type = "viridis") +
  scale_x_continuous(breaks = c(1, 3, 5, 7, 9, 11)) +
  theme(axis.ticks = element_blank(),
        axis.text = element_text(color = "black"),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        legend.position = "bottom",
        legend.key.size = unit(0.15, "cm"),
        legend.key.width = unit(0.8, "cm"),
        legend.title.align = 0.5) +
  geom_tile(color = "white", size = 0.1) +
  facet_wrap(~Plate) +
  theme(strip.background = element_blank())



```
</div>

<style> 
.column-left{float: left; width: 50%; text-align: left;}
.column-right{float: right;width: 50%;text-align: right}
</style>

<div class="column-left">
<br/> 
<br/> 
<br/> 
<br/> 
<br/> 

```{r standard-plot, out.width='100%', fig.align='center', fig.height= 4, fig.width=4, fig.dpi = 300, fig.cap="Hydroysis extent of wheat starch overtime"}

# import the dataset and add a new colume


# this new column will help us do the plot

hydro <- read_csv("data/tidydata/data_6P_cal_3nd.csv")%>% 
  mutate(status = case_when( ## creat a new column to classify three different conditions
    Sample == "C+" ~ "pos_control", ## if the sample name is C+, give it pos_control
    Sample == "C-" ~ "neg_control", ## if the sample name is C-, give it neg_control
    TRUE ~ "other" ## if it's not the cases above, give it other
  )) 

# creat a new column to distingrish each sample 

hydro <- hydro %>% 
  mutate(Well = paste(Plate, Row, Col, sep = "_")) 

# remove the outlier at 20min in plate 1

## find the outlier first

find_max <- hydro %>% 
  filter(Time == 20) %>% 
  arrange(desc(HE))

## remove it

hydro_no_outlier <- hydro %>% 
  filter(!(Time == 20 & Well == "1_C_11"))

# plotting the hydrolysis extent overtime

ggplot(data = hydro_no_outlier, aes(x = Time, 
                         y = HE,
                         group = Well,
                         color = status)) +
  geom_point(size = 1, shape = 1) + ## use hollow circles by "shape = 1"
  geom_line(size = 0.05) + # make the line thinner
  scale_color_brewer(palette = "Set1") +
  scale_y_continuous(limits = c(0,100), expand = c(0, 0)) + ## set the range of the y axis with no more expand
  scale_x_continuous(limits = c(0, 2000), expand = c(0, 0)) +
  ylab("Hydrolysis extent (%)") + ## change the label for the y axis
  xlab("Time (min)") + ## change the name of the x axis
  theme(legend.title = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(colour = "black", size = 0.5),
        panel.background = element_rect(fill = "white"),
        axis.ticks=element_line(colour="black", size=.5)) +
  labs(x = "Time (min)", y = "Hydrolysis extent (%)") +
  theme(axis.text.x = element_text(color="black", size=10), 
        axis.text.y = element_text(color="black", size=10)) +
   
  theme(legend.key = element_blank(),
        legend.position = "bottom") +
  theme(plot.margin = unit(c(5.5,12,5.5,5.5), "pt")) + ## set the margin
  facet_wrap(~ Plate)
```

</div>

<div class="column-right">

```{r curvefitting, out.width='100%', fig.align='center', fig.height= 4, fig.width = 4, fig.dpi = 300, fig.cap="An example of the fitted curves"}


# filter the data frame to have just the sample 92

## sample 77 

sample_77 <- hydro %>% 
  filter(Sample == "77") %>% 
  filter(!is.na(HE)) ### remove the missing value

model_77 <- nls(formula = HE ~ Xinf*(1-exp(-k*Time**(1-h))), 
             data = sample_77,
             start = list(Xinf = 100,
                          k = 0.001,
                          h = 0.001)) ### the estimated Xinf is 72.8686, h is 0.0977, k is 0.0044

## positive control

pos_control <- hydro %>% 
  filter(Sample == "C+") %>% 
  filter(!is.na(HE))

model_pos <- nls(formula = HE ~ Xinf*(1-exp(-k*Time**(1-h))), 
             data = pos_control,
             start = list(Xinf = 100,
                          k = 0.001,
                          h = 0.001)) ### the estimated Xinf is 84.8588, h is -0.2282, k is 0.0016

## negative control

neg_control <- hydro %>% 
  filter(Sample == "C-") %>% 
  filter(!is.na(HE))

model_neg <- nls(formula = HE ~ Xinf*(1-exp(-k*Time**(1-h))), 
             data = neg_control,
             start = list(Xinf = 100,
                          k = 0.001,
                          h = 0.001)) ### the estimated Xinf is 55.3105, h is 0.1469, k is 0.0088

# creat a tibble that contains these three samples together

three_samples <- hydro %>% 
  filter(Sample == "C+" | Sample == "C-" | Sample == "77") %>% 
  filter(!is.na(HE))

# define the sample col as a factor

three_samples$status <- factor(three_samples$status, levels = c("", "Sample", "Negative control"))

# plotting
 
ggplot(data = three_samples, aes(x = Time, y = HE, alpha = 0.6, color = Sample)) +
  
  ## add sample 77
  
  geom_point(size = 2, shape = 1) + 
  scale_color_manual(labels = c("Positive control", "Sample","Negative control"), values = c("#fc8d62", "#66c2a5", "#8da0cb")) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
    scale_x_continuous(limits = c(0, 2000), expand = c(0, 0)) +
  ylab("Hydrolysis extent (%)") + ### change the label for the y axis
  xlab("Time (min)") + ### change the name of the x axis
  theme(legend.title = element_blank(),
        panel.grid = element_blank(),
        axis.line = element_line(colour = "black", size = 0.5),
        panel.background = element_rect(fill = "white"),
        axis.ticks=element_line(colour="black", size=.5)) +
  labs(x = "Time (min)", y = "Hydrolysis extent (%)") +
  theme(axis.text.x = element_text(color="black", size=10), 
        axis.text.y = element_text(color="black", size=10)) +
  theme(legend.key = element_blank(),
        legend.position = "bottom") +
  theme(plot.margin = unit(c(5.5,12,5.5,5.5), "pt")) +
  
 ## add negative control
  
   stat_function(data = neg_control, fun = function(Time){55.3105*(1-exp(-0.0088*Time**(1-0.1469)))}, col = "#66c2a5", size = 0.7) +

  ## add sample
  
   stat_function(data = sample_77, fun = function(Time){72.8686*(1-exp(-0.0044*Time**(1-0.0977)))}, col = "#fc8d62", size = 0.7) +
  
  ## add positive control

   stat_function(data = pos_control, fun = function(Time){84.8588*(1-exp(-0.0016*Time**(1+0.2282)))}, col = "#8da0cb", size = 0.7) 
  
 
 
  
   

```

</div>


# My Data School Experience

It's an awesome learning experience for me. What I really appreciate is that they explained the codes in detail which lead us to a real understanding of what we were computing at the moment. I've already applied what I've learnt in data school to my daily work, and it's always exciting to discover more codes that help us solve various problems. 







